// Code generated by hertz generator.

package pub

import (
	"context"
	"github.com/cloudwego/hertz/pkg/app"
	"github.com/cloudwego/hertz/pkg/common/hlog"
	"path"
	"saas/app/admin/config"
	"saas/app/admin/idl_gen/model/admin/pub"
	"saas/app/admin/pkg/errno"
	"saas/app/admin/pkg/minio"
	"saas/app/admin/pkg/utils"
	"strconv"
	"time"
)

// Upload .
// @router /api/pub/upload/ [POST]
func Upload(ctx context.Context, c *app.RequestContext) {
	var err error
	var req pub.UploadReq
	err = c.BindAndValidate(&req)
	if err != nil {
		utils.SendResponse(c, errno.ConvertErr(err), nil, 0, "")
		return
	}

	file, _ := c.FormFile("file")
	nowTime := time.Now()
	filename := minio.NewFileName(0, nowTime.UnixMicro())
	file.Filename = filename + path.Ext(file.Filename)
	uploadinfo, err := minio.PutToBucket(ctx, config.GlobalServerConfig.Minio.ImgBucketName, file)
	hlog.CtxInfof(ctx, "image upload size:"+strconv.FormatInt(uploadinfo.Size, 10))
	if err != nil {
		hlog.CtxInfof(ctx, "err:"+err.Error())
	}
	url := minio.URLconvert(ctx, c, config.GlobalServerConfig.Minio.ImgBucketName+"/"+uploadinfo.Key)
	utils.SendResponse(c, errno.Success, map[string]string{
		"url": url,
	}, 1, "")

	return
}
